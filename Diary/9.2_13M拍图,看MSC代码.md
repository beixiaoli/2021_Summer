## 拍图
- 暗部偏绿：根据Sensor Offset联动关系，对应log的增益TGAIN修改对应倍数的Sensor Offset参数。
- 偏色：AWB？AWB生效需要时间+需要参照物，如果是纯色背景AWB容易失效，最好放置一个白色/灰色物体在纯色背景前

### 日志
2021.09.02  
工作总结：  
1. MSC部分代码：CalculateDefault4MSC。
2. 各场景拍图。出现暗部偏绿，对照常见效果问题-暗部偏色：过小偏紫，过大偏绿，黑电平BLC/SO问题。根据增益修改Sensor Offset的对应值：若暗部偏绿，可以增大绿色分量的绝对值或者减小红蓝分量的绝对值或者减小所有分量的绝对值。
3. 连上工具调试SO，稍微增大绿色分量绝对值（-64→-70，过小偏紫）可以消除暗部偏绿。（对比度gamma，锐化，降噪：用工具，在2112x1568的分辨率下面去调试）
4. 用工具拍同场景图，暗部不偏色，尺寸2112x1568，dat文件转成头文件，发去修改。
5. 偏绿可能原因：①拍照暗部偏绿：Sensor Offset；②镜头遮盖时画面四周偏绿：13M电压问题？。	  
明日计划：机器修改后重拍同组图作对比看暗部偏绿、对比度有无改善。

- 不是拼接效果问题  

## 自动化

### 手动分块
- 输入4208x3120的图，输入左右图尺寸3264x3120/1008x3120
- 计算出32块的矩阵
- 不需要显示lut，直接输出结果矩阵
- 输出两个头文件

### 需求
- 输入：大尺寸图像（例如4208x3120），左边图像宽度，右边图像宽度
- 输出：2个头文件中，msc部分的参数
- 看明白原来代码后，想想怎么分块计算msc好？是整幅图分31x16块计算矩阵，还是切成2幅图再各自计算16x16矩阵？
- 要求还能设置补偿系数。

### MSC文档
- ISP的LSC和MSC模块是根据像素在图像中所处的位置，给予相应的增益。  
- LSC模块增益与像素离图像中心的距离有关，所以补偿增益呈同心圆分布。
- MSC模块增益受矩阵分配，可用于shading不中心对称的场景。  MSC→矩阵  
- msc_mode：MSC分块以及最大增益选择。
- msc_blw_lut[11]：MSC分块宽度表。取值范围：[ 2，1023]
分块宽度是左右对称的，因此这是左半边11块（或8块）的分块宽度。以图像宽度1920为例，如果是16x16平均分块，1920/16=120，则分块宽度表为{120, 120, 120, 120, 120, 120, 120, 120}，宽度表的总和必须等于图像宽度的一半。

### MSC代码：CalculateDefault4MSC
> 怎么分块计算msc好？是整幅图分31x16块计算矩阵，还是切成2幅图再各自计算16x16矩阵？    

16\*16/22\*22  
31\*16：溢出问题  
```
/* enter raw calibration */
	int *height_div = new int[block_num/2]; //————————————无法整除：block_num/2+1
	int *width_div = new int[block_num/2];
	int *height_com = new int[block_num];
	int *width_com = new int[block_num];
	int *height_sum = new int[block_num + 1];
	int *width_sum = new int[block_num + 1];
	int *rtable = new int[block_num*block_num];
	int *gtable = new int[block_num*block_num];
	int *btable = new int[block_num*block_num];
	int max_val = max_gain * (1 << fix_bit) - 1;
```

**可能的三种分块计算MSC方法：MSC算法可以计算不对称的图像！只是补偿矩阵是对称的  **
1. 复制重叠部分buffer 32\*16
- 复制重叠部分
~ 复制之后图像非对称，需要将代码改成非对称算法，即把所有数组翻倍。~
- 分块矩阵从16\*16/22\*22扩成32\*32，计算r/g/bTable需要的相应补偿矩阵也需要更改
2. 31\*16
- 因为31是奇数，无法整除2，可以适当扩大内存空间，比如block_num/2改成block_num/2+1
- 分块矩阵从16\*16/22\*22扩成32\*32，计算r/g/bTable需要的相应补偿矩阵也需要更改
- 相当于分块数量多了一倍
3. 切成两幅图 16\*16
- 输入裁剪后的图像进行计算
- 裁剪后也是不对称的
- 根据输入左右图像尺寸计算分块宽高并使用
- 得到r/g/bTable之后还需要给右图增益加倍（）


- 输入：大尺寸图像（例如4208x3120），左边图像宽度，右边图像宽度
- 输出：2个头文件中，msc部分的参数
- r/g/b table ：保存最后一次calculate得到的rgbtable，若要对应头文件中msc部分的参数，需要根据最后一次计算对应msc-?
- r/g/b table 和 msc table 都只是面板显示数据，头文件记录下所有计算数据 


