## 8.9

### 降噪标定：解决setting问题
逐步修改setting查看是否出图，MSC模块开启时无法出图，因为sensor默认标定LSC而没有标定MSC，MSC没有标定时不能打开MSC模块。  

### 抓图比较
在室内开灯、关灯、室外环境下分别使用ori和标定后的denoise参数抓图、录像（静态和动态）。  
录像需要使用新版本awTuningApp，并在Venc Coder更改码率mBitRate为12M，录像的视频快放正常，但掉帧不正常，play录像模块需要先stop再关闭，不然会闪退。  
比较图像和录像，当HfRatiox0.25时高频噪声过多故不x0.25，标定后画面的噪点减少但边缘也被模糊。

### 改错
ori和back的dat文件compare发现除了BDNF和denoise参数，Venc Coder内码率相关参数有不同，原因是标定使用旧版awTuningApp而抓图时因为要使用录像功能改用新版，两版的码率默认参数不同，dat文件可能保存了旧版导致参数不同，从而导致录像效果不准确。ori和back的区别仅在BDNF曲线和DenoiseTable，前者为机器标定结果即初始值，后者为D2D手动标定结果。  
> 下次对比的也要重拍，尽量保证对比在同一亮度环境下进行。  
> 录像基本看不出差异，编码把不同降噪后的小差异都消除了。  
> 在编码前，降噪标定的弱纹理保留得更好。  

### 设备连上工具后无法调节增益：
原因：彩色驱动寄存器错误  
对照驱动看数据手册的AEC/AGC曝光/增益控制策略，根据控制方法改驱动里sensor_exp/gain的set函数。  



## 8.10

###2M标定（不能一次标定多个ISO，会因为未知原因闪退）；8M标定（一次标定多ISO）。  
注1：对新设备要重新push新的app。  
注2：标定途中若断开，可以在工具文件夹检查denoise曲线参数查看已标定完的ISO，然后标定剩下的ISO。  
注3：查看sensor信息：cat /sys/kernel/debug/mpp/vi  

### [sensor逐行曝光原理](https://blog.csdn.net/qq_42261630/article/details/109161790)  
1. sensor逐行曝光原理
HTS(行长：一行的长度) = length + HB(行消隐时间)  
VTS(帧长：一帧的行数) = width + VB(帧消隐时间)  
①line_time = line_length / pclk  
曝光一行时间 = 一行长度 / 像素时钟(单位时间采样像素)  
②exposure_time = exposure_line * line_time  
一帧曝光时间 = 一帧曝光行数 * 曝光一行时间   
③FPS = pclk / (VTS*HTS)  
帧率 = 像素时钟(单位时间采样像素)/(帧长*行长)(一帧总像素)  

2. 对应datasheetAEC/AGC控制说明：  
默认调节步长为1/16行曝光时间，即默认16为一行（16只是单位无实际意义）。  
一行行曝光时间等于行长乘以 TP(PCLK的一个周期)，即①曝光一行时间=行长/PCLK(1/TP)。  
曝光时间上限不能超过帧长减6行，即曝光时间取决于曝光行数和一行的时间，一行的时间往往是我们已知的，而曝光行数却不一定，但其一定不超过帧长VTS。  

3. 因为曝光时间(曝光行数)有VTS这一上限，所以有时候我们标定时遇到调节曝光图像不变的情况，不一定是驱动的曝光设置函数不正确，可能是曝光调得太高以至于超过了上限VTS，当超过上限时，不论调高调低图像都不会变。  
如何知道这个上限：由于VTS=width+VB，我们可以用width来大概计算曝光上限，比如客户设备扫描笔分辨率width只有480，那么曝光行数就不能大于大约480*16=7680；而对于两百万像素的镜头，曝光行数调节上限就扩大到大约1024*16=16384。  

> 曝光时间上限不能超过帧长减X行，X是sensor决定的，可通过查询规格书得到。    
